<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" type="text/css" href="{{ static_url('css/jquery.ui.chatbox.css') }}"/>
  <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
  <script src="{{ static_url('js/jquery.ui.chatbox.js') }}"></script>

  <script>
        var socket = new WebSocket('ws://' + location.host + '/chat');

        function sendAction(user_id, msg) {

            var message = {
                id: user_id,
                message: msg
            };

            socket.send(JSON.stringify(message));
        }

        socket.onopen = function(event) {
        }

        socket.onclose = function() {
        }

        socket.onmessage = function(event) {
            var data = JSON.parse(event.data);
            console.log(data);
            if ('messages' in data) {
                var messages = data.messages;
                for (var i = 0; i < messages.length; i++) {
                    $("#chat_div").chatbox("option", "boxManager").addMsg(messages[i].id, messages[i].message);
                }
            } else {
                $("#chat_div").chatbox("option", "boxManager").addMsg(data.id, data.message);
            }
        }

        $(document).ready(function() {
            $("#chat_div").chatbox(
                {//id : "chat_div",
                 title : "Chat De Tornado",
                 user : "hoge",
                 offset: 0,
                 width: 500,
                 messageSent: function(id, user, msg){
                     var user_id = $('#user_id').text();
                     this.boxManager.addMsg(user_id, msg);
                     sendAction(user_id, msg);
            }});
        });






  </script>
</head>
<body>
<div id="user_id" style="visibility:hidden">{{ user_id }}</div>
<div id="chat_div" class="chat"></div>
</body>
</html>